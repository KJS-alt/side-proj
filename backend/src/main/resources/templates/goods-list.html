<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>OnBid 물건 조회</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; }
        
        /* 네비게이션 */
        nav {
            background: #2c3e50;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        nav ul {
            list-style: none;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
        }
        nav li { margin: 0; }
        nav a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px 25px;
            transition: background 0.3s;
        }
        nav a:hover { background: #34495e; }
        nav a.active { background: #3498db; }
        
        /* 컨테이너 */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        h1 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        /* 검색 폼 */
        .search-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn-group {
            text-align: right;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover { background: #2980b9; }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* 메시지 */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 3px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        /* XML 결과 */
        .result-box {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 500px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 페이지네이션 */
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        
        .pagination a {
            display: inline-block;
            padding: 8px 15px;
            margin: 0 5px;
            background: white;
            color: #3498db;
            text-decoration: none;
            border: 1px solid #3498db;
            border-radius: 3px;
        }
        
        .pagination a:hover {
            background: #3498db;
            color: white;
        }
        
        .pagination .current {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav>
        <ul>
            <li><a href="/">홈</a></li>
            <li><a href="/goods/list" class="active">물건 조회</a></li>
            <li><a href="/goods/list?sido=서울특별시">서울 물건</a></li>
            <li><a href="/goods/list?sido=부산광역시">부산 물건</a></li>
        </ul>
    </nav>
    
    <!-- 메인 컨텐츠 -->
    <div class="container">
        <h1>OnBid 물건 조회</h1>
        
        <!-- 검색 폼 -->
        <div class="search-box">
            <form method="get" action="/goods/list">
                <div class="form-row">
                    <div class="form-group">
                        <label>시/도</label>
                        <select name="sido">
                            <option value="">전체</option>
                            <option value="서울특별시" th:selected="${sido == '서울특별시'}">서울특별시</option>
                            <option value="부산광역시" th:selected="${sido == '부산광역시'}">부산광역시</option>
                            <option value="대구광역시" th:selected="${sido == '대구광역시'}">대구광역시</option>
                            <option value="인천광역시" th:selected="${sido == '인천광역시'}">인천광역시</option>
                            <option value="광주광역시" th:selected="${sido == '광주광역시'}">광주광역시</option>
                            <option value="대전광역시" th:selected="${sido == '대전광역시'}">대전광역시</option>
                            <option value="울산광역시" th:selected="${sido == '울산광역시'}">울산광역시</option>
                            <option value="경기도" th:selected="${sido == '경기도'}">경기도</option>
                            <option value="강원도" th:selected="${sido == '강원도'}">강원도</option>
                            <option value="충청북도" th:selected="${sido == '충청북도'}">충청북도</option>
                            <option value="충청남도" th:selected="${sido == '충청남도'}">충청남도</option>
                            <option value="전라북도" th:selected="${sido == '전라북도'}">전라북도</option>
                            <option value="전라남도" th:selected="${sido == '전라남도'}">전라남도</option>
                            <option value="경상북도" th:selected="${sido == '경상북도'}">경상북도</option>
                            <option value="경상남도" th:selected="${sido == '경상남도'}">경상남도</option>
                            <option value="제주특별자치도" th:selected="${sido == '제주특별자치도'}">제주특별자치도</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>시/군/구</label>
                        <input type="text" name="sgk" th:value="${sgk}" placeholder="예: 강남구">
                    </div>
                    
                    <div class="form-group">
                        <label>읍/면/동</label>
                        <input type="text" name="emd" th:value="${emd}" placeholder="예: 역삼동">
                    </div>
                    
                    <div class="form-group">
                        <label>물건명</label>
                        <input type="text" name="cltrNm" th:value="${cltrNm}" placeholder="예: 아파트">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>감정가 (최소)</label>
                        <input type="number" name="goodsPriceFrom" th:value="${goodsPriceFrom}" placeholder="예: 10000000">
                    </div>
                    
                    <div class="form-group">
                        <label>감정가 (최대)</label>
                        <input type="number" name="goodsPriceTo" th:value="${goodsPriceTo}" placeholder="예: 50000000">
                    </div>
                    
                    <div class="form-group">
                        <label>조회 개수</label>
                        <select name="numOfRows">
                            <option value="5" th:selected="${numOfRows == 5}">5</option>
                            <option value="10" th:selected="${numOfRows == 10}">10</option>
                            <option value="20" th:selected="${numOfRows == 20}">20</option>
                            <option value="50" th:selected="${numOfRows == 50}">50</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>페이지</label>
                        <input type="number" name="pageNo" th:value="${pageNo}" min="1">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="reset" class="btn btn-secondary" onclick="window.location.href='/goods/list'">초기화</button>
                    <button type="submit" class="btn btn-primary">검색</button>
                </div>
            </form>
        </div>
        
        <!-- 성공 메시지 -->
        <div th:if="${success}" class="alert alert-success">
            ✓ API 호출 성공
        </div>
        
        <!-- 에러 메시지 -->
        <div th:if="${!success}" class="alert alert-error">
            ✗ API 호출 실패: <span th:text="${error}"></span>
        </div>
        
        <!-- 검색 정보 -->
        <div th:if="${success}" class="alert alert-info">
            <strong>검색 결과:</strong> 
            페이지 <span th:text="${pageNo}"></span>, 
            <span th:text="${numOfRows}"></span>개 조회
            <span th:if="${sido}">, 지역: <span th:text="${sido}"></span></span>
        </div>
        
        <!-- 검색 결과 테이블 -->
        <div th:if="${xmlResponse}">
            <h3>검색 결과</h3>
            <div id="results"></div>
            <div class="result-box" id="xmlData" style="display:none;" th:text="${xmlResponse}"></div>
            
            <script>
                // XML 파싱 및 테이블 생성
                const xmlText = document.getElementById('xmlData').textContent;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                
                // totalCount 추출
                const totalCount = xmlDoc.querySelector('totalCount')?.textContent || '0';
                
                // items 추출
                const items = xmlDoc.querySelectorAll('item');
                
                let html = `
                    <div class="alert alert-info">
                        <strong>총 ${totalCount}건</strong> 검색됨 (현재 페이지: ${items.length}건)
                    </div>
                `;
                
                if (items.length > 0) {
                    html += `
                        <table style="width:100%; border-collapse:collapse; background:white; margin-top:15px;">
                            <thead style="background:#3498db; color:white;">
                                <tr>
                                    <th style="padding:12px; border:1px solid #ddd;">번호</th>
                                    <th style="padding:12px; border:1px solid #ddd;">카테고리</th>
                                    <th style="padding:12px; border:1px solid #ddd;">물건명</th>
                                    <th style="padding:12px; border:1px solid #ddd;">소재지</th>
                                    <th style="padding:12px; border:1px solid #ddd;">감정가</th>
                                    <th style="padding:12px; border:1px solid #ddd;">최저입찰가</th>
                                    <th style="padding:12px; border:1px solid #ddd;">입찰기간</th>
                                    <th style="padding:12px; border:1px solid #ddd;">상태</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    items.forEach((item, index) => {
                        const rnum = item.querySelector('RNUM')?.textContent || '-';
                        const category = item.querySelector('CTGR_FULL_NM')?.textContent || '-';
                        const name = item.querySelector('CLTR_NM')?.textContent || '-';
                        const addr = item.querySelector('NMRD_ADRS')?.textContent || 
                                    item.querySelector('LDNM_ADRS')?.textContent || '-';
                        const appraisal = parseInt(item.querySelector('APSL_ASES_AVG_AMT')?.textContent || '0');
                        const minBid = parseInt(item.querySelector('MIN_BID_PRC')?.textContent || '0');
                        const bidStart = item.querySelector('PBCT_BEGN_DTM')?.textContent || '';
                        const bidEnd = item.querySelector('PBCT_CLS_DTM')?.textContent || '';
                        const status = item.querySelector('PBCT_CLTR_STAT_NM')?.textContent || '-';
                        
                        // 날짜 포맷팅 (YYYYMMDDHHMISS -> YYYY-MM-DD HH:MM)
                        const formatDate = (str) => {
                            if (str.length >= 12) {
                                return `${str.substr(0,4)}-${str.substr(4,2)}-${str.substr(6,2)} ${str.substr(8,2)}:${str.substr(10,2)}`;
                            }
                            return str;
                        };
                        
                        // 금액 포맷팅
                        const formatPrice = (price) => {
                            return price.toLocaleString('ko-KR') + '원';
                        };
                        
                        html += `
                            <tr style="border-bottom:1px solid #ddd;">
                                <td style="padding:10px; border:1px solid #ddd; text-align:center;">${rnum}</td>
                                <td style="padding:10px; border:1px solid #ddd;">${category}</td>
                                <td style="padding:10px; border:1px solid #ddd; max-width:300px; overflow:hidden; text-overflow:ellipsis;" title="${name}">${name}</td>
                                <td style="padding:10px; border:1px solid #ddd; max-width:200px; overflow:hidden; text-overflow:ellipsis;" title="${addr}">${addr}</td>
                                <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatPrice(appraisal)}</td>
                                <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatPrice(minBid)}</td>
                                <td style="padding:10px; border:1px solid #ddd; font-size:11px;">
                                    ${formatDate(bidStart)}<br>~ ${formatDate(bidEnd)}
                                </td>
                                <td style="padding:10px; border:1px solid #ddd; text-align:center;">
                                    <span style="display:inline-block; padding:5px 10px; background:#e8f5e9; color:#2e7d32; border-radius:3px; font-size:12px;">${status}</span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                } else {
                    html += '<div class="alert alert-info">검색 결과가 없습니다.</div>';
                }
                
                document.getElementById('results').innerHTML = html;
            </script>
        </div>
        
        <!-- 페이지네이션 -->
        <div th:if="${success}" class="pagination">
            <a th:if="${pageNo > 1}"
               th:href="@{/goods/list(pageNo=${pageNo - 1}, numOfRows=${numOfRows}, sido=${sido}, sgk=${sgk}, emd=${emd}, cltrNm=${cltrNm}, goodsPriceFrom=${goodsPriceFrom}, goodsPriceTo=${goodsPriceTo})}">
                ← 이전
            </a>
            <a href="#" class="current" th:text="${pageNo}">1</a>
            <a th:href="@{/goods/list(pageNo=${pageNo + 1}, numOfRows=${numOfRows}, sido=${sido}, sgk=${sgk}, emd=${emd}, cltrNm=${cltrNm}, goodsPriceFrom=${goodsPriceFrom}, goodsPriceTo=${goodsPriceTo})}">
                다음 →
            </a>
        </div>
    </div>
</body>
</html>